name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build docs/
        run: |
          rm -rf docs && mkdir -p docs
          EXCLUDE=".git node_modules server src tools exports analytics_data cloud_data docs"
          for item in * .[^.]* ; do
            skip=false
            for ex in $EXCLUDE; do [ "$item" = "$ex" ] && skip=true && break; done
            $skip && continue
            cp -r "$item" docs/ 2>/dev/null || true
          done
          echo '{"API_URL":"https://superspace-server-production.up.railway.app"}' > docs/config.json
          touch docs/.nojekyll
          echo "Copied $(find docs -type f | wc -l) files"

      - name: Commit and push docs/
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f docs/
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "chore: update docs/ [skip ci]"
          git push
