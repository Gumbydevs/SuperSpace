<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperSpace Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #00ff88;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            background: #00ff88;
            color: #000;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 20px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: #00ff88;
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.2);
            transform: translateY(-5px);
        }

        .metric-card h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .metric-subtitle {
            font-size: 0.9em;
            color: #cccccc;
            text-align: center;
            margin-bottom: 15px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .large-chart {
            grid-column: span 2;
        }

        .event-log {
            grid-column: span 2;
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: rgba(0, 0, 0, 0.3);
            margin: 5px 0;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #00ff88;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .event-timestamp {
            color: #00ff88;
            font-weight: bold;
        }

        .event-type {
            color: #ffaa00;
            font-weight: bold;
        }

        .event-details {
            color: #cccccc;
            margin-left: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .stat-label {
            font-size: 0.8em;
            color: #cccccc;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #00ff88;
        }

        .loading {
            text-align: center;
            color: #00ff88;
            font-style: italic;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 136, 0.8);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #00cc6a;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .large-chart,
            .event-log {
                grid-column: span 1;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ SuperSpace Analytics Dashboard</h1>
        <div class="status-indicator" id="statusIndicator">LIVE</div>
    </div>

    <div class="refresh-indicator" id="refreshIndicator" style="opacity: 0;">
        Refreshing...
    </div>

    <div class="dashboard-container">
        <!-- Live Player Count -->
        <div class="metric-card">
            <h3>üéÆ Active Players</h3>
            <div class="metric-value" id="activePlayers">0</div>
            <div class="metric-subtitle">Currently Online</div>
        </div>

        <!-- Peak Players Today -->
        <div class="metric-card">
            <h3>üìà Peak Today</h3>
            <div class="metric-value" id="peakPlayers">0</div>
            <div class="metric-subtitle">Maximum Concurrent</div>
        </div>

        <!-- Total Sessions -->
        <div class="metric-card">
            <h3>üî¢ Total Sessions</h3>
            <div class="metric-value" id="totalSessions">0</div>
            <div class="metric-subtitle">All Time</div>
        </div>

        <!-- Average Session Time -->
        <div class="metric-card">
            <h3>‚è±Ô∏è Avg Session</h3>
            <div class="metric-value" id="avgSessionTime">0m</div>
            <div class="metric-subtitle">Time Played</div>
        </div>

        <!-- Player Activity Chart -->
        <div class="metric-card large-chart">
            <h3>üìä Player Activity (Last 24 Hours)</h3>
            <div class="chart-container">
                <canvas id="playerActivityChart"></canvas>
            </div>
        </div>

        <!-- Game Events Chart -->
        <div class="metric-card large-chart">
            <h3>‚ö° Game Events (Real-time)</h3>
            <div class="chart-container">
                <canvas id="gameEventsChart"></canvas>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="metric-card">
            <h3>üéØ Game Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Kills Today</div>
                    <div class="stat-value" id="killsToday">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Deaths Today</div>
                    <div class="stat-value" id="deathsToday">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Shots Fired</div>
                    <div class="stat-value" id="shotsFired">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Power-ups</div>
                    <div class="stat-value" id="powerupsCollected">0</div>
                </div>
            </div>
        </div>

        <!-- Premium Statistics -->
        <div class="metric-card">
            <h3>üíé Premium Stats</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Premium Players</div>
                    <div class="stat-value" id="premiumPlayers">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Store Visits</div>
                    <div class="stat-value" id="storeVisits">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Purchases</div>
                    <div class="stat-value" id="purchases">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Revenue</div>
                    <div class="stat-value" id="revenue">$0</div>
                </div>
            </div>
        </div>

        <!-- Live Event Log -->
        <div class="metric-card event-log">
            <h3>üì° Live Event Stream</h3>
            <div id="eventLog" class="scrollbar">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <script>
        let playerActivityChart, gameEventsChart;
        let eventData = [];
        let chartData = {
            labels: [],
            datasets: [{
                label: 'Active Players',
                data: [],
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                fill: true,
                tension: 0.4
            }]
        };

        let gameEventChartData = {
            labels: ['Kills', 'Deaths', 'Shots', 'Power-ups', 'Purchases'],
            datasets: [{
                label: 'Events',
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ],
                borderWidth: 2
            }]
        };

        function initCharts() {
            // Player Activity Chart
            const playerCtx = document.getElementById('playerActivityChart').getContext('2d');
            playerActivityChart = new Chart(playerCtx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#cccccc' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#cccccc' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Game Events Chart
            const eventsCtx = document.getElementById('gameEventsChart').getContext('2d');
            gameEventsChart = new Chart(eventsCtx, {
                type: 'doughnut',
                data: gameEventChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function updateMetrics(data) {
            // Update basic metrics
            document.getElementById('activePlayers').textContent = data.activePlayers || 0;
            document.getElementById('peakPlayers').textContent = data.peakPlayers || 0;
            document.getElementById('totalSessions').textContent = data.totalSessions || 0;
            
            // Format average session time
            const avgTime = data.avgSessionTime || 0;
            const minutes = Math.floor(avgTime / 60);
            const seconds = avgTime % 60;
            document.getElementById('avgSessionTime').textContent = `${minutes}m ${seconds}s`;

            // Update game statistics
            document.getElementById('killsToday').textContent = data.killsToday || 0;
            document.getElementById('deathsToday').textContent = data.deathsToday || 0;
            document.getElementById('shotsFired').textContent = data.shotsFired || 0;
            document.getElementById('powerupsCollected').textContent = data.powerupsCollected || 0;

            // Update premium statistics
            document.getElementById('premiumPlayers').textContent = data.premiumPlayers || 0;
            document.getElementById('storeVisits').textContent = data.storeVisits || 0;
            document.getElementById('purchases').textContent = data.purchases || 0;
            document.getElementById('revenue').textContent = `$${(data.revenue || 0).toFixed(2)}`;

            // Update charts
            if (data.playerActivity) {
                updatePlayerActivityChart(data.playerActivity);
            }

            if (data.gameEvents) {
                updateGameEventsChart(data.gameEvents);
            }

            // Update event log
            if (data.recentEvents) {
                updateEventLog(data.recentEvents);
            }
        }

        function updatePlayerActivityChart(activityData) {
            if (!activityData || activityData.length === 0) return;

            chartData.labels = activityData.map(point => {
                const date = new Date(point.timestamp);
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            });
            chartData.datasets[0].data = activityData.map(point => point.count);

            playerActivityChart.update('none');
        }

        function updateGameEventsChart(events) {
            gameEventChartData.datasets[0].data = [
                events.kills || 0,
                events.deaths || 0,
                events.shots || 0,
                events.powerups || 0,
                events.purchases || 0
            ];

            gameEventsChart.update('none');
        }

        function updateEventLog(events) {
            const eventLog = document.getElementById('eventLog');
            const maxEvents = 50;

            // Keep only recent events
            eventData = [...events.slice(-maxEvents)];

            eventLog.innerHTML = eventData.map(event => {
                const timestamp = new Date(event.timestamp).toLocaleTimeString();
                return `
                    <div class="event-item">
                        <span class="event-timestamp">[${timestamp}]</span>
                        <span class="event-type">${event.type.toUpperCase()}</span>
                        <span class="event-details">${formatEventDetails(event)}</span>
                    </div>
                `;
            }).reverse().join('');

            // Auto-scroll to top (newest events)
            eventLog.scrollTop = 0;
        }

        function formatEventDetails(event) {
            switch (event.type) {
                case 'player_joined':
                    return `Player joined the game`;
                case 'player_left':
                    return `Player left after ${Math.floor(event.data?.sessionTime || 0)}s`;
                case 'kill':
                    return `Kill with ${event.data?.weapon || 'unknown weapon'}`;
                case 'death':
                    return `Player died (${event.data?.cause || 'unknown cause'})`;
                case 'weapon_fired':
                    return `${event.data?.weapon || 'Weapon'} fired`;
                case 'powerup_collected':
                    return `Collected ${event.data?.type || 'powerup'}`;
                case 'premium_purchase':
                    return `Premium purchase: $${event.data?.amount || 0}`;
                case 'store_visit':
                    return `Store visited`;
                case 'achievement_unlocked':
                    return `Achievement: ${event.data?.name || 'Unknown'}`;
                default:
                    return event.data ? JSON.stringify(event.data) : '';
            }
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 1000);
        }

        async function fetchAnalyticsData() {
            try {
                showRefreshIndicator();
                // Use the Render server analytics endpoint instead of Vercel
                const response = await fetch('https://superspace-server.onrender.com/analytics');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateMetrics(data);
                
                // Update status indicator
                document.getElementById('statusIndicator').textContent = 'LIVE';
                document.getElementById('statusIndicator').style.background = '#00ff88';
                
            } catch (error) {
                console.error('Failed to fetch analytics data:', error);
                
                // Update status indicator to show error
                document.getElementById('statusIndicator').textContent = 'OFFLINE';
                document.getElementById('statusIndicator').style.background = '#ff4444';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            fetchAnalyticsData();
            
            // Auto-refresh every 5 seconds
            setInterval(fetchAnalyticsData, 5000);
            
            console.log('üöÄ SuperSpace Analytics Dashboard Initialized');
        });

        // Handle visibility change to pause/resume updates
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                fetchAnalyticsData();
            }
        });
    </script>
</body>
</html>
